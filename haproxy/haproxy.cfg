global
    # ログ設定
    log stdout format raw local0
    
    # 最大接続数
    maxconn 4096
    
    # デーモンモードを無効化（Dockerコンテナ内で実行するため）
    # daemon

defaults
    # デフォルトモード
    mode http
    
    # ログ設定
    log global
    option httplog
    option dontlognull
    
    # タイムアウト設定
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    
    # HTTPキープアライブ
    option http-keep-alive
    
    # サーバーエラー時のリトライ
    retries 3
    option redispatch

# 統計情報画面（オプション）
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE

# フロントエンド設定
frontend http-in
    bind *:80
    
    # デフォルトバックエンド
    default_backend app_servers
    
    # アクセスログ
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"

# バックエンド設定
backend app_servers
    # ラウンドロビン方式でロードバランシング
    balance roundrobin
    
    # ヘルスチェック設定
    option httpchk GET /health
    http-check expect status 200
    
    # X-Forwarded-Forヘッダーを追加
    option forwardfor
    
    # サーバークローズ時の処理
    option http-server-close
    
    # DNSベースのサービスディスカバリー設定
    # docker composeのDNSを利用してappサービスを解決
    server-template app 10 app:8080 check resolvers docker init-addr libc,none
    
# Docker内部DNS設定
resolvers docker
    # Dockerの内部DNSサーバーを指定
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold other      10s
    hold refused    10s
    hold nx         10s
    hold timeout    10s
    hold valid      10s
    hold obsolete   10s
